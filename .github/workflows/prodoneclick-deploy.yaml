name: Production One Click Deployment

on:
  workflow_dispatch:
    inputs:
      RC_COMMIT:
        description: 'Orchestrator Commit SHA'
        required: true
        default: 'main'
      EVENT_DRIVEN_REF:
        description: 'Branch or tag in event-driven-repo'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}

      EVENT_DRIVEN_APP_AZ1: ${{ secrets.EVENT_DRIVEN_APP_AZ1 }}
      EVENT_DRIVEN_APP_AZ2: ${{ secrets.EVENT_DRIVEN_APP_AZ2 }}
      EVENT_DRIVEN_APP_AZ3: ${{ secrets.EVENT_DRIVEN_APP_AZ3 }}

      EVENT_SERVICE_APP_AZ1: ${{ secrets.EVENT_SERVICE_APP_AZ1 }}
      EVENT_SERVICE_APP_AZ2: ${{ secrets.EVENT_SERVICE_APP_AZ2 }}
      EVENT_SERVICE_APP_AZ3: ${{ secrets.EVENT_SERVICE_APP_AZ3 }}

      TOLERANT_READER_APP_AZ1: ${{ secrets.TOLERANT_READER_APP_AZ1 }}
      TOLERANT_READER_APP_AZ2: ${{ secrets.TOLERANT_READER_APP_AZ2 }}
      TOLERANT_READER_APP_AZ3: ${{ secrets.TOLERANT_READER_APP_AZ3 }}

    steps:

    - name: Checkout Orchestrator Repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set RC_COMMIT
      run: echo "RC_COMMIT=${{ github.event.inputs.RC_COMMIT || github.sha }}" >> $GITHUB_ENV

    - name: Print ENV VARS
      run: |
        echo "RC_COMMIT = $RC_COMMIT"
        echo "EVENT_DRIVEN_APP_AZ1 = $EVENT_DRIVEN_APP_AZ1"
        echo "EVENT_DRIVEN_APP_AZ2 = $EVENT_DRIVEN_APP_AZ2"
        echo "EVENT_DRIVEN_APP_AZ3 = $EVENT_DRIVEN_APP_AZ3"
        echo "HEROKU_API_KEY = $HEROKU_API_KEY"

    - name: Checkout Event Driven Repo
      uses: actions/checkout@v3
      with:
        repository: writetojags/event-driven-repo
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.event.inputs.EVENT_DRIVEN_REF }}
        path: event-driven
        fetch-depth: 0

    - name: Deploy Event Driven Service
      working-directory: ./event-driven
      run: |
        bash ../.github/scripts/deploy-prod.sh event_driven "$RC_COMMIT" "$EVENT_DRIVEN_APP_AZ1" "$EVENT_DRIVEN_APP_AZ2" "$EVENT_DRIVEN_APP_AZ3"

    - name: Deploy Event Service
      run: |
        bash .github/scripts/deploy-prod.sh event "$RC_COMMIT"

    - name: Deploy Tolerant Reader Service
      run: |
        bash .github/scripts/deploy-prod.sh tolerant_reader "$RC_COMMIT"
