name: Production One Click Deploy

on:
  push:
    bramches:
      - main
  workflow_dispatch:
    inputs:
      RC_COMMIT:
        description: 'Release Candidate Commit SHA'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}

      #EVENT_DRIVEN_APP_AZ1: ${{ secrets.EVENT_DRIVEN_APP_AZ1 }}
      #EVENT_DRIVEN_APP_AZ2: ${{ secrets.EVENT_DRIVEN_APP_AZ2 }}
      #EVENT_DRIVEN_APP_AZ3: ${{ secrets.EVENT_DRIVEN_APP_AZ3 }}

      EVENT_SERVICE_APP_AZ1: ${{ secrets.EVENT_SERVICE_APP_AZ1 }}
      EVENT_SERVICE_APP_AZ2: ${{ secrets.EVENT_SERVICE_APP_AZ2 }}
      EVENT_SERVICE_APP_AZ3: ${{ secrets.EVENT_SERVICE_APP_AZ3 }}

      TOLERANT_READER_APP_AZ1: ${{ secrets.TOLERANT_READER_APP_AZ1 }}
      TOLERANT_READER_APP_AZ2: ${{ secrets.TOLERANT_READER_APP_AZ2 }}
      TOLERANT_READER_APP_AZ3: ${{ secrets.TOLERANT_READER_APP_AZ3 }}

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    #- name: Deploy Event Driven Service
     # run: |
      #  bash .github/scripts/deploy-prod.sh event_driven_service ${{ github.event.inputs.RC_COMMIT }}

    - name: Deploy Event Service
      run: |
        bash .github/scripts/deploy-prod.sh event_service ${{ github.event.inputs.RC_COMMIT }}

    - name: Deploy Tolerant Reader Service
      run: |
        bash .github/scripts/deploy-prod.sh tolerant_reader_service ${{ github.event.inputs.RC_COMMIT }}
