name: Production One Click Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      RC_COMMIT:
        description: 'Orchestrator commit SHA or branch to deploy (default: main)'
        required: true
        default: 'main'
      EVENT_DRIVEN_REF:
        description: 'Branch or tag in event-driven-repo (default: master)'
        required: false
      EVENT_SERVICE_REF:
        description: 'Branch or tag in event-service-repo (default: main)'
        required: false
      TOLERANT_READER_REF:
        description: 'Branch or tag in tolerant-reader-repo (default: main)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Heroku credentials
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}

      # AZ app names for event-driven
      EVENT_DRIVEN_APP_AZ1: ${{ secrets.EVENT_DRIVEN_APP_AZ1 }}
      EVENT_DRIVEN_APP_AZ2: ${{ secrets.EVENT_DRIVEN_APP_AZ2 }}
      EVENT_DRIVEN_APP_AZ3: ${{ secrets.EVENT_DRIVEN_APP_AZ3 }}

      # AZ app names for event-service
      EVENT_SERVICE_APP_AZ1: ${{ secrets.EVENT_SERVICE_APP_AZ1 }}
      EVENT_SERVICE_APP_AZ2: ${{ secrets.EVENT_SERVICE_APP_AZ2 }}
      EVENT_SERVICE_APP_AZ3: ${{ secrets.EVENT_SERVICE_APP_AZ3 }}

      # AZ app names for tolerant-reader
      TOLERANT_READER_APP_AZ1: ${{ secrets.TOLERANT_READER_APP_AZ1 }}
      TOLERANT_READER_APP_AZ2: ${{ secrets.TOLERANT_READER_APP_AZ2 }}
      TOLERANT_READER_APP_AZ3: ${{ secrets.TOLERANT_READER_APP_AZ3 }}

    steps:

    - name: ✅ Checkout Orchestrator Repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: ✅ Set RC_COMMIT for Orchestrator
      run: |
        echo "⚙️  Evaluating RC_COMMIT..."
        if [ -z "${{ github.event.inputs.RC_COMMIT }}" ]; then
          echo "RC_COMMIT=main" >> $GITHUB_ENV
        else
          echo "RC_COMMIT=${{ github.event.inputs.RC_COMMIT }}" >> $GITHUB_ENV
        fi
        echo "✅ RC_COMMIT set to: $RC_COMMIT"

    - name: ✅ Determine Event Driven Ref
      run: |
        if [ -z "${{ github.event.inputs.EVENT_DRIVEN_REF }}" ]; then
          echo "EVENT_DRIVEN_REF=master" >> $GITHUB_ENV
        else
          echo "EVENT_DRIVEN_REF=${{ github.event.inputs.EVENT_DRIVEN_REF }}" >> $GITHUB_ENV
        fi

    - name: ✅ Determine Event Service Ref
      run: |
        if [ -z "${{ github.event.inputs.EVENT_SERVICE_REF }}" ]; then
          echo "EVENT_SERVICE_REF=main" >> $GITHUB_ENV
        else
          echo "EVENT_SERVICE_REF=${{ github.event.inputs.EVENT_SERVICE_REF }}" >> $GITHUB_ENV
        fi

    - name: ✅ Determine Tolerant Reader Ref
      run: |
        if [ -z "${{ github.event.inputs.TOLERANT_READER_REF }}" ]; then
          echo "TOLERANT_READER_REF=main" >> $GITHUB_ENV
        else
          echo "TOLERANT_READER_REF=${{ github.event.inputs.TOLERANT_READER_REF }}" >> $GITHUB_ENV
        fi

    - name: ✅ Print All ENV Vars for Debugging uses
      run: |
        echo "--- ENVIRONMENT VARIABLES ---"
        echo "RC_COMMIT = $RC_COMMIT"
        echo "EVENT_DRIVEN_REF = $EVENT_DRIVEN_REF"
        echo "EVENT_SERVICE_REF = $EVENT_SERVICE_REF"
        echo "TOLERANT_READER_REF = $TOLERANT_READER_REF"
        echo "HEROKU_API_KEY = ${HEROKU_API_KEY:0:4}********"
        echo "EVENT_DRIVEN_APP_AZ1 = $EVENT_DRIVEN_APP_AZ1"
        echo "EVENT_SERVICE_APP_AZ1 = $EVENT_SERVICE_APP_AZ1"
        echo "TOLERANT_READER_APP_AZ1 = $TOLERANT_READER_APP_AZ1"
        echo "--- END ENV ---"
    - name: ✅ Print Event Service Secrets
      run: |
        echo "EVENT_SERVICE_APP_AZ1 = $EVENT_SERVICE_APP_AZ1"
        echo "EVENT_SERVICE_APP_AZ2 = $EVENT_SERVICE_APP_AZ2"
        echo "EVENT_SERVICE_APP_AZ3 = $EVENT_SERVICE_APP_AZ3"

    - name: ✅ Checkout Event Driven Repo
      uses: actions/checkout@v3
      with:
        repository: writetojags/event-driven-repo
        token: ${{ secrets.EVENT_DRIVEN_REPO_TOKEN }}
        ref: ${{ env.EVENT_DRIVEN_REF }}
        path: event-driven
        fetch-depth: 0

    - name: ✅ Checkout Event Service Repo
      uses: actions/checkout@v3
      with:
        repository: writetojags/event-driven-service-repo
        token: ${{ secrets.EVENT_SERVICE_REPO_TOKEN }}
        ref: ${{ env.EVENT_SERVICE_REF }}
        path: event-service
        fetch-depth: 0

    - name: ✅ Checkout Tolerant Reader Repo
      uses: actions/checkout@v3
      with:
        repository: writetojags/tolerant-reader-service
        token: ${{ secrets.TOLERANT_READER_REPO_TOKEN }}
        ref: ${{ env.TOLERANT_READER_REF }}
        path: tolerant-reader
        fetch-depth: 0

    - name: 🚀 Deploy Event Driven Service to Production
      working-directory: ./event-driven
      run: |
        echo "=== Deploy Event Driven Service ==="
        echo "RC_COMMIT = $RC_COMMIT"
        bash ../.github/scripts/deploy-prod.sh event_driven "$RC_COMMIT" "$EVENT_DRIVEN_APP_AZ1" "$EVENT_DRIVEN_APP_AZ2" "$EVENT_DRIVEN_APP_AZ3"

    - name: 🚀 Deploy Event Service to Production
      working-directory: ./event-service
      run: |
        echo "=== Deploy Event Service ==="
        echo "RC_COMMIT = $RC_COMMIT"
        bash ../.github/scripts/deploy-prod.sh event_service "$RC_COMMIT" "$EVENT_SERVICE_APP_AZ1" "$EVENT_SERVICE_APP_AZ2" "$EVENT_SERVICE_APP_AZ3"

    - name: 🚀 Deploy Tolerant Reader Service to Production
      working-directory: ./tolerant-reader
      run: |
        echo "=== Deploy Tolerant Reader Service ==="
        echo "RC_COMMIT = $RC_COMMIT"
        bash ../.github/scripts/deploy-prod.sh tolerant_reader "$RC_COMMIT" "$TOLERANT_READER_APP_AZ1" "$TOLERANT_READER_APP_AZ2" "$TOLERANT_READER_APP_AZ3"
