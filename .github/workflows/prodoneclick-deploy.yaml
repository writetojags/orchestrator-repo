name: Deploy Tolerant Reader - Production

on:
 push:
   branches:
     - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
      TOLERANT_READER_APP_AZ1: ${{ secrets.TOLERANT_READER_APP_AZ1 }}
      TOLERANT_READER_APP_AZ2: ${{ secrets.TOLERANT_READER_APP_AZ2 }}
      TOLERANT_READER_APP_AZ3: ${{ secrets.TOLERANT_READER_APP_AZ3 }}

    steps:
    - name: Checkout Orchestrator Repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set RC_COMMIT
      run: echo "RC_COMMIT=${{ github.event.inputs.RC_COMMIT || github.sha }}" >> $GITHUB_ENV

    - name: Print ENV VARS
      run: |
        echo "RC_COMMIT = $RC_COMMIT"
        echo "HEROKU_API_KEY = $HEROKU_API_KEY"
        echo "TOLERANT_READER_APP_AZ1 = $TOLERANT_READER_APP_AZ1"
        echo "TOLERANT_READER_APP_AZ2 = $TOLERANT_READER_APP_AZ2"
        echo "TOLERANT_READER_APP_AZ3 = $TOLERANT_READER_APP_AZ3"

    - name: Deploy Tolerant Reader Service to Production
      run: |
        bash .github/scripts/deploy-prod.sh tolerant_reader "$RC_COMMIT" "$TOLERANT_READER_APP_AZ1" "$TOLERANT_READER_APP_AZ2" "$TOLERANT_READER_APP_AZ3"
