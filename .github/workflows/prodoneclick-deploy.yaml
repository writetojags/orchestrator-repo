name: Production One Click Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      RC_COMMIT:
        description: 'Release Candidate Commit SHA'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}

      EVENT_DRIVEN_APP_AZ1: ${{ secrets.EVENT_DRIVEN_APP_AZ1 }}
      EVENT_DRIVEN_APP_AZ2: ${{ secrets.EVENT_DRIVEN_APP_AZ2 }}
      EVENT_DRIVEN_APP_AZ3: ${{ secrets.EVENT_DRIVEN_APP_AZ3 }}

      EVENT_SERVICE_APP_AZ1: ${{ secrets.EVENT_SERVICE_APP_AZ1 }}
      EVENT_SERVICE_APP_AZ2: ${{ secrets.EVENT_SERVICE_APP_AZ2 }}
      EVENT_SERVICE_APP_AZ3: ${{ secrets.EVENT_SERVICE_APP_AZ3 }}

      TOLERANT_READER_APP_AZ1: ${{ secrets.TOLERANT_READER_APP_AZ1 }}
      TOLERANT_READER_APP_AZ2: ${{ secrets.TOLERANT_READER_APP_AZ2 }}
      TOLERANT_READER_APP_AZ3: ${{ secrets.TOLERANT_READER_APP_AZ3 }}

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
   -  name: Set RC_COMMIT
      run: echo "RC_COMMIT=$RC_COMMIT" >> $GITHUB_ENV
      env:
        RC_COMMIT: ${{ github.event.inputs.RC_COMMIT || github.sha }}




    - name: Print ENV VARS
      run: |
        echo "RC_COMMIT = $RC_COMMIT"
        echo "EVENT_DRIVEN_APP_AZ1 = $EVENT_DRIVEN_APP_AZ1"
        echo "EVENT_DRIVEN_APP_AZ2 = $EVENT_DRIVEN_APP_AZ2"
        echo "EVENT_DRIVEN_APP_AZ3 = $EVENT_DRIVEN_APP_AZ3"
        echo "HEROKU_API_KEY = $HEROKU_API_KEY"

    - name: Deploy Event Driven Service
      run: |
        bash .github/scripts/deploy-prod.sh event_driven \
          ${{ github.event.inputs.RC_COMMIT }} \
          "$EVENT_DRIVEN_APP_AZ1" "$EVENT_DRIVEN_APP_AZ2" "$EVENT_DRIVEN_APP_AZ3"

    - name: Deploy Event Service
      run: |
        bash .github/scripts/deploy-prod.sh event ${{ github.event.inputs.RC_COMMIT }}

    - name: Deploy Tolerant Reader Service
      run: |
        bash .github/scripts/deploy-prod.sh tolerant_reader ${{ github.event.inputs.RC_COMMIT }}
